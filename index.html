<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Código Racional - Sistema de Créditos Mentais (fix)</title>

    <!-- Font Awesome (fallback/icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js (mantido) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Fonte de roteiro (adicionada, sem quebrar nada) -->
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ============================
           VARIÁVEIS E TEMAS (original + extras não-invasivos)
           ============================ */
        :root {
            --primary: #5dadec;
            --primary-dark: #2a80b9;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --background: #0d1f2d;
            --card: #1a2e3f;
            --card-light: #223c51;
            --text: #e6f2ff;
            --text-muted: #a0c5e6;
            --accent: #9b59b6;
            --sidebar-width: 250px;
            --header-height: 60px;
        }

        /* Temas originais (mantidos) */
        .theme-dark    { /* (mantive seus valores originais) */ --primary: #5dadec; --background:#0d1f2d; --card:#1a2e3f; }
        .theme-oled    { --background:#000000; --card:#111111; --primary:#5dadec; }
        .theme-neutral { --background:#f8f9fa; --card:#ffffff; --text:#212529; --primary:#6c757d; }
        .theme-white   { --background:#ffffff; --card:#f8f9fa; --text:#212529; --primary:#007bff; }
        .theme-comfort { --background:#f5f5f5; --card:#ffffff; --text:#212121; --primary:#4a6572; }
        .theme-aurora  { --background:#0a3d62; --card:#1e5799; --text:#dff9fb; --primary:#78e08f; }
        .theme-dracula  { --background:#282a36; --card:#44475a; --primary:#ff79c6; }
        .theme-nord    { --background:#2e3440; --card:#3b4252; --primary:#81a1c1; }
        .theme-deep-ocean { --background:#0f111a; --card:#1f2233; --primary:#82aaff; }
        .theme-monokai { --background:#272822; --card:#3e3d32; --primary:#fd971f; }
        .theme-solarized { --background:#002b36; --card:#073642; --primary:#b58900; }
        .theme-github-dark { --background:#0d1117; --card:#161b22; --primary:#58a6ff; }

        /* Extras (BetterDiscord-ish) adicionados de forma NÃO invasiva */
        .theme-midnight  { --background:#12121c; --card:#1e1e2e; --primary:#5865f2; }
        .theme-vaporwave { --background:#2b0033; --card:#3b1c47; --primary:#ff77ff; }
        .theme-cyberpunk { --background:#050406; --card:#111111; --primary:#fcee09; }
        .theme-neon      { --background:#000010; --card:#0d0d25; --primary:#39ff14; }
        .theme-matrix    { --background:#000000; --card:#001100; --primary:#00ff00; }
        .theme-pastel    { --background:#fff5fb; --card:#fff0f5; --primary:#ff8fab; --text:#222; }
        .theme-tokyo     { --background:#1a1b26; --card:#24283b; --primary:#7aa2f7; }

        /* ============================
           Reset / Base - PRESERVADO (com pequena correção: body overflow)
           ============================ */
        * { box-sizing: border-box; margin:0; padding:0; }
        html, body { height:100%; }
        body {
            /* Fonte alterada para Courier Prime (apenas a família) */
            font-family: "Courier Prime", "Segoe UI", Tahoma, Arial, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* CORREÇÃO CRÍTICA: permitir scroll (removi overflow: hidden que quebrou seu scroll) */
            overflow: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ============================
           Cabeçalho - mantido (pequenos ajustes não-destrutivos)
           ============================ */
        .app-header {
            height: var(--header-height);
            background-color: var(--card);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
        }

        .logo { display:flex; align-items:center; margin-right:30px; font-weight:bold; font-size:1.1rem; color:var(--primary); }
        .logo-icon { font-size:1.6rem; margin-right:10px; }

        .tabs-container { display:flex; flex:1; height:100%; overflow-x:auto; scrollbar-width:none; }
        .tabs-container::-webkit-scrollbar{ display:none; }

        .tab {
            padding: 0 20px; height:100%; display:flex; align-items:center; cursor:pointer;
            font-weight:600; color:var(--text-muted); border-bottom:3px solid transparent;
            transition: all 0.3s ease; white-space:nowrap; flex-shrink:0;
        }
        .tab:hover { color:var(--text); background-color: rgba(255,255,255,0.03); }
        .tab.active { color:var(--primary); border-bottom:3px solid var(--primary); background-color: rgba(93,173,236,0.06); }

        .header-actions { display:flex; align-items:center; gap:15px; flex-shrink:0; }
        .menu-toggle { background:none; border:none; color:var(--text); font-size:1.5rem; cursor:pointer; display:none; }

        /* ============================
           Main layout - mantido com overflow controlado
           ============================ */
        .main-container {
            display:flex; flex:1;
            /* Em vez de height fixa que causava barras internas, usar min-height e permitir ao body cuidar do scroll */
            overflow: visible;
            min-height: calc(100vh - var(--header-height));
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--card);
            height: 100%;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            padding: 20px 0;
            display:flex; flex-direction:column; flex-shrink:0;
            max-height: calc(100vh - var(--header-height));
        }

        .profile { display:flex; flex-direction:column; align-items:center; padding: 0 20px 20px; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.06); }
        .profile-img { width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--primary); margin-bottom:15px; box-shadow:0 0 15px rgba(93,173,236,0.25); }
        .profile-name { font-size:1.05rem; font-weight:600; margin-bottom:10px; text-align:center; }

        .sidebar-menu { list-style:none; padding:0; margin:0; flex-grow:1; }
        .menu-item { padding:12px 20px; display:flex; align-items:center; cursor:pointer; color:var(--text); text-decoration:none; transition: background-color 0.3s ease; border-left:4px solid transparent; }
        .menu-item:hover { background-color: rgba(255,255,255,0.03); }
        .menu-item.active { background-color: rgba(93,173,236,0.12); border-left:4px solid var(--primary); }

        .menu-item i { font-size:1.2rem; width:24px; text-align:center; margin-right:15px; }

        /* ============================
           Main Content
           ============================ */
        .main-content {
            flex:1; padding:20px;
            /* permitir ao body o scroll principal - evita barras duplas */
            overflow-y: visible;
            max-height: calc(100vh - var(--header-height));
            -webkit-overflow-scrolling: touch;
        }

        .tab-content { display:none; animation: fadeIn 0.35s ease; height:auto; overflow:visible; }
        .tab-content.active { display:block; }

        /* ======= Dashboard / Cards (preserve design) ======= */
        .saldo-container { text-align:center; margin-bottom:30px; padding:25px; background-color:var(--card); border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.03); }
        .saldo-label { font-size:1.1rem; color:var(--text-muted); margin-bottom:10px; }
        .saldo { font-size:3.2rem; font-weight:bold; margin:10px 0; background:linear-gradient(135deg,var(--primary) 0%, var(--text) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .saldo.positivo { background:linear-gradient(135deg,var(--success) 0%, #a4ffc9 100%); -webkit-background-clip:text; }
        .saldo.negativo { background:linear-gradient(135deg,var(--danger) 0%, #ff9d8f 100%); -webkit-background-clip:text; }

        .botoes-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:15px; margin-bottom:30px; }
        .btn {
            padding:15px; border:none; border-radius:12px; font-size:0.95rem; font-weight:600; cursor:pointer;
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            box-shadow:0 4px 10px rgba(0,0,0,0.12), 0 1px 3px rgba(0,0,0,0.06);
            transition: all 0.2s ease; background: linear-gradient(135deg, var(--card-light) 0%, var(--card) 100%); color:var(--text); border:1px solid rgba(255,255,255,0.03)
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .btn i { font-size:1.6rem; margin-bottom:10px; }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%); color: white; }
        .btn-danger  { background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); color: white; }

        .stats-container { display:grid; grid-template-columns:1fr; gap:20px; margin-bottom:30px; }
        .stat-card { background-color:var(--card); border-radius:15px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.03); }
        .stat-card h3 { color:var(--primary); margin-bottom:15px; display:flex; align-items:center; gap:10px; }

        .historico { background-color:var(--card); border-radius:15px; padding:25px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:30px; border:1px solid rgba(255,255,255,0.03); }
        .historico h3 { margin-top: 0; color:var(--primary); margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.06); display:flex; align-items:center; gap:10px; }

        /* minimal theme-preview look (non-invasive) */
        .themes-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:20px; margin-top:20px; }
        .theme-card { background: linear-gradient(135deg, var(--card-light) 0%, var(--card) 100%); border-radius:12px; padding:16px; cursor:pointer; transition: all 0.25s ease; border:2px solid transparent; }
        .theme-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.12); }
        .theme-card.active { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(93,173,236,0.06); }

        /* onboarding preserved */
        .onboarding { position: fixed; inset: 0; background-color: rgba(0,0,0,0.45); z-index: 2000; display:flex; align-items:center; justify-content:center; }
        .onboarding-content { background-color: var(--card); border-radius:18px; padding:30px; max-width:540px; width:92%; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.03); text-align:center; }

        /* small helpers */
        @media (min-width:768px) { .stats-container { grid-template-columns: 1fr 1fr; } }
        @media (max-width:768px) {
            .menu-toggle { display:block; }
            .sidebar { position: fixed; left: -100%; top: var(--header-height); height: calc(100vh - var(--header-height)); z-index: 90; transition: left 0.3s ease; }
            .sidebar.open { left: 0; }
            .tabs-container { display:none; }
        }

        @keyframes fadeIn { from { opacity:0; transform: translateY(8px) } to { opacity:1; transform: translateY(0) } }

        /* ============================
           Pequena utilidade para ícones skeuomórficos (opcional)
           - Não altera ícones existentes, apenas disponibiliza
           ============================ */
        .s-ico { display:inline-block; width:28px; height:28px; border-radius:6px; filter: drop-shadow(0 6px 10px rgba(0,0,0,0.45)); }
    </style>
</head>
<body class="theme-dark">
    <!-- Onboarding (preservado do original) -->
    <div class="onboarding" id="onboarding" style="display:none">
        <div class="onboarding-content">
            <div class="onboarding-step active" id="step1">
                <div class="onboarding-icon"><i class="fas fa-skull"></i></div>
                <h2 class="onboarding-title">Bem-vindo ao Código Racional</h2>
                <p class="onboarding-text">Um sistema inteligente para gerenciar seus créditos mentais e melhorar sua produtividade através de recompensas and métricas.</p>
                <div class="onboarding-navigation" style="display:flex;justify-content:space-between;margin-top:20px">
                    <button class="onboarding-btn skip" onclick="skipOnboarding()">Pular</button>
                    <button class="onboarding-btn" onclick="nextOnboardingStep()">Próximo</button>
                </div>
            </div>
            <div class="onboarding-step" id="step2" style="display:none">
                <div class="onboarding-icon"><i class="fas fa-brain"></i></div>
                <h2 class="onboarding-title">Como Funciona</h2>
                <p class="onboarding-text">O Código Racional ajuda você a monitorar suas atividades produtivas e improdutivas, atribuindo valores de CR (Créditos Racionais) a cada ação.</p>
                <div class="onboarding-navigation" style="display:flex;justify-content:space-between;margin-top:20px">
                    <button class="onboarding-btn" onclick="prevOnboardingStep()">Voltar</button>
                    <button class="onboarding-btn" onclick="nextOnboardingStep()">Próximo</button>
                </div>
            </div>
            <div class="onboarding-step" id="step3" style="display:none">
                <div class="onboarding-icon"><i class="fas fa-user-circle"></i></div>
                <h2 class="onboarding-title">Personalize seu Perfil</h2>
                <p class="onboarding-text">Configure sua foto e nome para personalizar sua experiência.</p>
                <div class="form-group">
                    <label for="onboarding-name">Seu Nome</label>
                    <input type="text" id="onboarding-name" placeholder="Como devemos te chamar?">
                </div>
                <div class="form-group">
                    <label for="onboarding-avatar">Avatar (URL)</label>
                    <input type="text" id="onboarding-avatar" placeholder="URL da sua imagem (opcional)">
                </div>
                <div class="onboarding-navigation" style="display:flex;justify-content:space-between;margin-top:20px">
                    <button class="onboarding-btn" onclick="prevOnboardingStep()">Voltar</button>
                    <button class="onboarding-btn" onclick="completeOnboarding()">Concluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cabeçalho com Abas (preservado) -->
    <header class="app-header">
        <div class="logo">
            <i class="fas fa-skull logo-icon"></i>
            <span>Código Racional</span>
        </div>

        <div class="tabs-container">
            <div class="tab active" data-tab="dashboard"><i class="fas fa-home"></i><span style="margin-left:8px">Dashboard</span></div>
            <div class="tab" data-tab="historico"><i class="fas fa-history"></i><span style="margin-left:8px">Histórico</span></div>
            <div class="tab" data-tab="estatisticas"><i class="fas fa-chart-pie"></i><span style="margin-left:8px">Estatísticas</span></div>
            <div class="tab" data-tab="temas"><i class="fas fa-palette"></i><span style="margin-left:8px">Temas</span></div>
            <div class="tab" data-tab="configuracoes"><i class="fas fa-cog"></i><span style="margin-left:8px">Configurações</span></div>
        </div>

        <div class="header-actions">
            <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <!-- Layout Principal (estrutura original preservada) -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="profile">
                <img src="https://ui-avatars.com/api/?name=Usuário&background=5dadec&color=fff" alt="Foto de perfil" class="profile-img" id="profileImage">
                <div class="profile-name" id="profileName">Usuário</div>
            </div>

            <ul class="sidebar-menu">
                <li>
                    <a href="#" class="menu-item active" data-tab="dashboard"><i class="fas fa-home"></i><span>Dashboard</span></a>
                </li>
                <li>
                    <a href="#" class="menu-item" data-tab="historico"><i class="fas fa-history"></i><span>Histórico</span></a>
                </li>
                <li>
                    <a href="#" class="menu-item" data-tab="estatisticas"><i class="fas fa-chart-pie"></i><span>Estatísticas</span></a>
                </li>
                <li>
                    <a href="#" class="menu-item" data-tab="temas"><i class="fas fa-palette"></i><span>Temas</span></a>
                </li>
                <li>
                    <a href="#" class="menu-item" data-tab="configuracoes"><i class="fas fa-cog"></i><span>Configurações</span></a>
                </li>
            </ul>
        </div>

        <!-- Conteúdo Principal -->
        <main class="main-content">
            <!-- Dashboard (preservado) -->
            <div class="tab-content active" id="dashboard-content">
                <div class="saldo-container">
                    <div class="saldo-label">Saldo Atual</div>
                    <div id="saldo" class="saldo positivo">20 CR</div>
                </div>

                <div class="botoes-container" id="activities-buttons">
                    <button class="btn btn-success" onclick="alterarCR(5, 'Aprendizado')">
                        <i class="fas fa-graduation-cap"></i>
                        +5 CR (Aprendizado)
                    </button>
                    <button class="btn btn-success" onclick="alterarCR(4, 'Exercício')">
                        <i class="fas fa-running"></i>
                        +4 CR (Exercício)
                    </button>
                    <button class="btn btn-success" onclick="alterarCR(2, 'Tarefa')">
                        <i class="fas fa-tasks"></i>
                        +2 CR (Tarefa)
                    </button>
                    <button class="btn btn-success" onclick="alterarCR(1, 'Leitura')">
                        <i class="fas fa-book"></i>
                        +1 CR (Leitura)
                    </button>

                    <button class="btn btn-danger" onclick="alterarCR(-1, 'Redes Sociais')">
                        <i class="fas fa-smile"></i>
                        -1 CR (Redes Sociais)
                    </button>
                    <button class="btn btn-danger" onclick="alterarCR(-3, 'Entretenimento')">
                        <i class="fas fa-gamepad"></i>
                        -3 CR (Entretenimento)
                    </button>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <h3><i class="fas fa-chart-line"></i> Desempenho Semanal</h3>
                        <div class="chart-container" style="position:relative;height:250px;"><canvas id="weeklyChart"></canvas></div>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-chart-pie"></i> Distribuição de Atividades</h3>
                        <div class="chart-container" style="position:relative;height:250px;"><canvas id="activityChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Histórico -->
            <div class="tab-content" id="historico-content" style="display:none">
                <div class="historico">
                    <h3><i class="fas fa-history"></i> Histórico de Transações</h3>
                    <div id="historico-transacoes">
                        <div class="empty-history">Nenhuma transação registrada ainda.</div>
                    </div>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="tab-content" id="estatisticas-content" style="display:none">
                <div class="stats-container">
                    <div class="stat-card">
                        <h3><i class="fas fa-chart-line"></i> Evolução de CR</h3>
                        <div class="chart-container" style="position:relative;height:250px;"><canvas id="evolutionChart"></canvas></div>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-calendar"></i> Atividades por Dia da Semana</h3>
                        <div class="chart-container" style="position:relative;height:250px;"><canvas id="weekdayChart"></canvas></div>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-clock"></i> Distribuição por Horário</h3>
                        <div class="chart-container" style="position:relative;height:250px;"><canvas id="timeChart"></canvas></div>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-tags"></i> Categorias de Atividades</h3>
                        <div class="chart-container" style="position:relative;height:250px;"><canvas id="categoryChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Temas -->
            <div class="tab-content" id="temas-content" style="display:none">
                <div class="themes-container">
                    <h3><i class="fas fa-palette"></i> Selecione um Tema</h3>
                    <p style="color:var(--text-muted)">Escolha um tema — adicionei os originais + extras (não invasivos).</p>

                    <div class="themes-grid" id="themes-grid">
                        <div class="theme-card active" data-theme="theme-dark">
                            <div class="theme-preview" style="height:80px;border-radius:8px;background:linear-gradient(135deg,#071b2b,#123b58);color:#fff;display:flex;align-items:center;justify-content:center">Dark</div>
                            <div class="theme-name">Dark</div>
                            <div class="theme-description" style="color:var(--text-muted)">Tema escuro padrão com cores suaves</div>
                        </div>

                        <div class="theme-card" data-theme="theme-oled">
                            <div class="theme-preview" style="height:80px;border-radius:8px;background:black;display:flex;align-items:center;justify-content:center;color:#fff">OLED</div>
                            <div class="theme-name">Dark OLED</div>
                            <div class="theme-description" style="color:var(--text-muted)">Preto puro para economizar bateria</div>
                        </div>

                        <div class="theme-card" data-theme="theme-aurora">
                            <div class="theme-preview" style="height:80px;border-radius:8px;background:linear-gradient(135deg,#00354b,#2ad7d2);display:flex;align-items:center;justify-content:center;color:#001">Aurora</div>
                            <div class="theme-name">Aurora</div>
                            <div class="theme-description" style="color:var(--text-muted)">Verde e azul com contraste suave</div>
                        </div>

                        <!-- Os demais temas serão adicionados via JS (não-invasivo) -->
                    </div>
                </div>
            </div>

            <!-- Configurações -->
            <div class="tab-content" id="configuracoes-content" style="display:none">
                <div class="settings-container">
                    <div class="settings-section">
                        <h3><i class="fas fa-user"></i> Perfil</h3>
                        <div class="form-group">
                            <label for="userName">Nome</label>
                            <input type="text" id="userName" placeholder="Digite seu nome" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)">
                        </div>
                        <div class="form-group">
                            <label for="userImageURL">URL da Imagem de Perfil</label>
                            <input type="text" id="userImageURL" placeholder="Cole a URL da imagem" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)">
                        </div>
                        <div class="form-actions" style="display:flex;justify-content:flex-end">
                            <button class="btn-save" onclick="saveProfile()">Salvar Perfil</button>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3><i class="fas fa-download"></i> Backup de Dados</h3>
                        <p style="color:var(--text-muted)">Faça backup dos seus dados para não perder suas informações.</p>
                        <div class="form-actions" style="display:flex;justify-content:flex-end;gap:8px">
                            <button class="btn-cancel" onclick="exportData()" style="padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.03)">Exportar Dados</button>
                            <button class="btn-save" onclick="importData()" style="padding:8px 12px;border-radius:8px;background:var(--primary);color:#001;border:none">Importar Dados</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ============================
         JS original (preservado) com pequenas proteções
         ============================ -->
    <script>
        // Dados iniciais (idênticos ao original)
        let saldo = 20;
        let historico = [];
        let userName = "Usuário";
        let userImageURL = "https://ui-avatars.com/api/?name=Usuário&background=5dadec&color=fff";
        let onboardingCompleted = false;
        let charts = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            checkOnboarding();
            atualizarExibicao();
            initCharts();
            populateExtraThemes(); // adiciona os temas extras (não-invasivo)
        });

        // Onboarding (mantido)
        function checkOnboarding() {
            try {
                onboardingCompleted = localStorage.getItem('onboardingCompleted') === 'true';
                const onboardingEl = document.getElementById('onboarding');
                if (onboardingEl) onboardingEl.style.display = onboardingCompleted ? 'none' : 'flex';
            } catch (e) { console.error(e); }
        }

        function nextOnboardingStep() {
            const steps = document.querySelectorAll('.onboarding-step');
            let currentActive = -1;
            steps.forEach((step, index) => {
                if (step.classList.contains('active')) { currentActive = index; step.classList.remove('active'); }
            });
            if (currentActive < steps.length - 1) steps[currentActive + 1].classList.add('active');
        }

        function prevOnboardingStep() {
            const steps = document.querySelectorAll('.onboarding-step');
            let currentActive = -1;
            steps.forEach((step, index) => {
                if (step.classList.contains('active')) { currentActive = index; step.classList.remove('active'); }
            });
            if (currentActive > 0) steps[currentActive - 1].classList.add('active');
        }

        function skipOnboarding() {
            const onboardingEl = document.getElementById('onboarding');
            if (onboardingEl) onboardingEl.style.display = 'none';
            onboardingCompleted = true;
            localStorage.setItem('onboardingCompleted', 'true');
        }

        function completeOnboarding() {
            const name = document.getElementById('onboarding-name')?.value;
            const avatar = document.getElementById('onboarding-avatar')?.value;
            if (name) {
                userName = name;
                document.getElementById('profileName').textContent = userName;
                document.getElementById('userName').value = userName;
            }
            if (avatar) {
                userImageURL = avatar;
                document.getElementById('profileImage').src = userImageURL;
                document.getElementById('userImageURL').value = userImageURL;
            }
            const onboardingEl = document.getElementById('onboarding');
            if (onboardingEl) onboardingEl.style.display = 'none';
            onboardingCompleted = true;
            localStorage.setItem('onboardingCompleted', 'true');
            saveData();
        }

        // Event listeners e tabs (preservado com leve verificação)
        function setupEventListeners() {
            const tabs = document.querySelectorAll('.tab');
            const menuItems = document.querySelectorAll('.menu-item');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    activateTab(tabId);
                });
            });

            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    activateTab(tabId);
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) sidebar.classList.remove('open');
                });
            });

            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', function() { sidebar.classList.toggle('open'); });
            }

            const themeCards = document.querySelectorAll('.theme-card');
            themeCards.forEach(card => {
                card.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    changeTheme(theme);
                    themeCards.forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        function activateTab(tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            const tabs = document.querySelectorAll('.tab');
            const menuItems = document.querySelectorAll('.menu-item');

            tabContents.forEach(content => { content.classList.remove('active'); content.style.display = 'none'; });
            tabs.forEach(tab => tab.classList.remove('active'));
            menuItems.forEach(item => item.classList.remove('active'));

            const target = document.getElementById(`${tabId}-content`);
            if (target) {
                target.classList.add('active');
                target.style.display = 'block';
            }
            const tabEl = document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (tabEl) tabEl.classList.add('active');
            const menuItemEl = document.querySelector(`.menu-item[data-tab="${tabId}"]`);
            if (menuItemEl) menuItemEl.classList.add('active');

            if (tabId === 'estatisticas') updateCharts();
        }

        function changeTheme(theme) {
            // Proteção: preserve outras classes não-tema, se existirem.
            try {
                document.body.className = theme;
                saveData();
            } catch (e) { console.error(e); }
        }

        // Funções de CR / histórico
        function alterarCR(valor, descricao) {
            saldo += valor;
            historico.push({ data: new Date().toISOString(), valor: valor, descricao: descricao });
            saveData();
            atualizarExibicao();
            if (document.getElementById('estatisticas-content')?.classList.contains('active')) updateCharts();
        }

        function atualizarExibicao() {
            const elementoSaldo = document.getElementById('saldo');
            if (!elementoSaldo) return;
            elementoSaldo.textContent = `${saldo} CR`;
            elementoSaldo.className = 'saldo';
            if (saldo >= 0) elementoSaldo.classList.add('positivo'); else elementoSaldo.classList.add('negativo');

            const elementoHistorico = document.getElementById('historico-transacoes');
            if (!elementoHistorico) return;
            elementoHistorico.innerHTML = '';
            if (historico.length === 0) {
                elementoHistorico.innerHTML = '<div class="empty-history">Nenhuma transação registrada ainda.</div>';
            } else {
                historico.slice().reverse().forEach(transacao => {
                    const divTransacao = document.createElement('div');
                    divTransacao.className = 'transacao';
                    const data = new Date(transacao.data).toLocaleString('pt-BR');
                    const valor = transacao.valor > 0 ? `<span class="positivo">+${transacao.valor} CR</span>` : `<span class="negativo">${transacao.valor} CR</span>`;
                    divTransacao.innerHTML = `
                        <div class="transacao-data">${data}</div>
                        <div class="transacao-descricao">${transacao.descricao}</div>
                        <div class="transacao-valor">${valor}</div>
                    `;
                    elementoHistorico.appendChild(divTransacao);
                });
            }
        }

        // Charts (mantive Chart.js e dados de exemplo; proteções pequenas)
        function initCharts() {
            createWeeklyChart();
            createActivityChart();
            createEvolutionChart();
            createWeekdayChart();
            createTimeChart();
            createCategoryChart();
        }

        function updateCharts() {
            for (const key in charts) {
                if (charts[key]) {
                    try { charts[key].destroy(); } catch (e) { /* ignore */ }
                }
            }
            initCharts();
        }

        function createWeeklyChart() {
            const el = document.getElementById('weeklyChart');
            if (!el) return;
            const ctx = el.getContext('2d');
            charts.weeklyChart = new Chart(ctx, {
                type: 'line',
                data: { labels: ['Seg','Ter','Qua','Qui','Sex','Sáb','Dom'], datasets: [{ label:'CR por Dia', data:[15,22,18,25,23,30,28], borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#5dadec', backgroundColor: 'rgba(93,173,236,0.1)', borderWidth:2, fill:true, tension:0.4 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
            });
        }

        function createActivityChart() {
            const el = document.getElementById('activityChart'); if (!el) return;
            const ctx = el.getContext('2d');
            charts.activityChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels:['Aprendizado','Exercício','Tarefas','Leitura','Redes Sociais','Entretenimento'], datasets:[{ data:[25,15,30,20,10,15], backgroundColor:['#5dadec','#2ecc71','#9b59b6','#f1c40f','#e74c3c','#ff6b6b'], borderWidth:0 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
            });
        }

        function createEvolutionChart() {
            const el = document.getElementById('evolutionChart'); if (!el) return;
            const ctx = el.getContext('2d');
            charts.evolutionChart = new Chart(ctx, {
                type: 'line',
                data: { labels:['Jan','Fev','Mar','Abr','Mai','Jun'], datasets:[{ label:'Evolução de CR', data:[15,25,20,35,30,45], borderColor:'#5dadec', backgroundColor:'rgba(93,173,236,0.1)', borderWidth:2, fill:true, tension:0.4 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
            });
        }

        function createWeekdayChart() {
            const el = document.getElementById('weekdayChart'); if (!el) return;
            const ctx = el.getContext('2d');
            charts.weekdayChart = new Chart(ctx, { type:'bar', data:{ labels:['Seg','Ter','Qua','Qui','Sex','Sáb','Dom'], datasets:[{ label:'Atividades', data:[12,19,15,17,14,16,18], backgroundColor:'#5dadec', borderWidth:0 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } } });
        }

        function createTimeChart() {
            const el = document.getElementById('timeChart'); if (!el) return;
            const ctx = el.getContext('2d');
            charts.timeChart = new Chart(ctx, { type:'bar', data:{ labels:['6h','9h','12h','15h','18h','21h'], datasets:[{ label:'Atividades', data:[8,15,12,10,18,14], backgroundColor:'#9b59b6', borderWidth:0 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } } });
        }

        function createCategoryChart() {
            const el = document.getElementById('categoryChart'); if (!el) return;
            const ctx = el.getContext('2d');
            charts.categoryChart = new Chart(ctx, { type:'pie', data:{ labels:['Produtivas','Improdutivas'], datasets:[{ data:[70,30], backgroundColor:['#2ecc71','#e74c3c'], borderWidth:0 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } } });
        }

        // Perfil, import/export (mantidos)
        function saveProfile() {
            const name = document.getElementById('userName')?.value;
            const url = document.getElementById('userImageURL')?.value;
            if (name) { userName = name; document.getElementById('profileName').textContent = userName; }
            if (url) { userImageURL = url; document.getElementById('profileImage').src = userImageURL; }
            saveData();
            alert('Perfil atualizado com sucesso!');
        }

        function exportData() {
            const dados = { saldo, historico, userName, userImageURL, onboardingCompleted, theme: document.body.className, dataExportacao:new Date().toISOString() };
            const blob = new Blob([JSON.stringify(dados,null,2)], { type:'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download = `codigo-racional-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input'); input.type='file'; input.accept='.json';
            input.onchange = e => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = function(ev) {
                    try {
                        const dados = JSON.parse(ev.target.result);
                        if (confirm('Isso substituirá todos os seus dados atuais. Continuar?')) {
                            saldo = dados.saldo ?? saldo;
                            historico = dados.historico ?? historico;
                            userName = dados.userName ?? userName;
                            userImageURL = dados.userImageURL ?? userImageURL;
                            onboardingCompleted = dados.onboardingCompleted ?? onboardingCompleted;
                            if (dados.theme) document.body.className = dados.theme;
                            saveData();
                            atualizarExibicao();
                            document.getElementById('userName').value = userName;
                            document.getElementById('userImageURL').value = userImageURL;
                            document.getElementById('profileName').textContent = userName;
                            document.getElementById('profileImage').src = userImageURL;
                            alert('Dados importados com sucesso!');
                        }
                    } catch (err) { alert('Erro ao importar dados. O arquivo pode estar corrompido.'); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function saveData() {
            const dados = { saldo, historico, userName, userImageURL, onboardingCompleted, theme: document.body.className };
            try { localStorage.setItem('codigoRacionalData', JSON.stringify(dados)); } catch (e) { console.error('saveData error', e); }
        }

        function loadData() {
            try {
                const raw = localStorage.getItem('codigoRacionalData');
                if (!raw) return;
                const dados = JSON.parse(raw);
                saldo = dados.saldo ?? saldo;
                historico = dados.historico ?? historico;
                userName = dados.userName ?? userName;
                userImageURL = dados.userImageURL ?? userImageURL;
                onboardingCompleted = dados.onboardingCompleted ?? onboardingCompleted;

                document.getElementById('userName') && (document.getElementById('userName').value = userName);
                document.getElementById('userImageURL') && (document.getElementById('userImageURL').value = userImageURL);
                document.getElementById('profileName') && (document.getElementById('profileName').textContent = userName);
                document.getElementById('profileImage') && (document.getElementById('profileImage').src = userImageURL);
                if (dados.theme) document.body.className = dados.theme;
            } catch (err) { console.error('Erro ao carregar dados salvos:', err); }
        }

        // Render histórico simples
        function renderHistorico() {
            const el = document.getElementById('historico-transacoes');
            if (!el) return;
            el.innerHTML = '';
            if (!historico || historico.length === 0) {
                el.innerHTML = '<div class="empty-history">Nenhuma transação registrada ainda.</div>';
                return;
            }
            historico.slice().reverse().forEach(transacao => {
                const row = document.createElement('div');
                row.className = 'transacao';
                const data = new Date(transacao.data).toLocaleString('pt-BR');
                row.innerHTML = `<div class="transacao-data">${data}</div><div class="transacao-descricao">${transacao.descricao}</div><div class="transacao-valor">${transacao.valor>0?'<span class="positivo">+'+transacao.valor+'</span>':'<span class="negativo">'+transacao.valor+'</span>'} CR</div>`;
                el.appendChild(row);
            });
        }

        // Garante que historico esteja renderizado
        function atualizarExibicao() {
            updateSaldoDisplay();
            renderHistorico();
        }

        function updateSaldoDisplay() {
            const sEl = document.getElementById('saldo');
            if (!sEl) return;
            sEl.textContent = saldo + ' CR';
            sEl.className = 'saldo';
            if (saldo >= 0) sEl.classList.add('positivo'); else sEl.classList.add('negativo');
            const mini = document.getElementById('miniSaldo'); if (mini) mini.textContent = saldo + ' CR';
        }

        // ADICIONA temas extras ao grid (NÃO invasivo)
        function populateExtraThemes() {
            const list = [
                {id:'theme-midnight', name:'Midnight'},
                {id:'theme-vaporwave', name:'Vaporwave'},
                {id:'theme-cyberpunk', name:'Cyberpunk'},
                {id:'theme-neon', name:'Neon Dreams'},
                {id:'theme-matrix', name:'Matrix Green'},
                {id:'theme-pastel', name:'Pastel Pink'},
                {id:'theme-tokyo', name:'Tokyo Night'}
            ];
            const container = document.getElementById('themes-grid');
            if (!container) return;
            list.forEach(t=>{
                if (container.querySelector(`.theme-card[data-theme="${t.id}"]`)) return;
                const card = document.createElement('div'); card.className='theme-card'; card.dataset.theme = t.id;
                card.innerHTML = `<div class="theme-preview" style="height:80px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#666,#333);color:#fff">${t.name}</div><div class="theme-name">${t.name}</div><div class="theme-description" style="color:var(--text-muted)">Tema adicional</div>`;
                container.appendChild(card);
            });

            // re-bind clicks (safer)
            document.querySelectorAll('.theme-card').forEach(card=>{
                if (!card._bound) {
                    card.addEventListener('click', function(){ document.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('active')); this.classList.add('active'); changeTheme(this.dataset.theme); });
                    card._bound = true;
                }
            });
        }

        // Boot: cria armazenamento inicial caso não exista
        (function(){ if (!localStorage.getItem('codigoRacionalData')) saveData(); })();
    </script>
</body>
</html>